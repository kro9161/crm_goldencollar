// ---------------------------------------------------
//  JUNCTION TABLE: SubGroupFilieres
// ---------------------------------------------------

model SubGroupFiliere {
  subGroupId String
  filiereId  String

  subGroup SubGroup @relation("SubGroupToSubGroupFiliere", fields: [subGroupId], references: [id])
  filiere  Filiere  @relation("FiliereToSubGroupFiliere", fields: [filiereId], references: [id])

  assignedAt DateTime @default(now())

  @@id([subGroupId, filiereId])
}
// ---------------------------------------------------
//  PRISMA SCHEMA ‚Äî CRM √âcole V1 COMPLET
// ---------------------------------------------------

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ---------------------------------------------------
//  ANN√âES & P√âRIODES
// ---------------------------------------------------

model AcademicYear {
  id        String   @id @default(cuid())
  name      String   @unique      // "2025-2026 Octobre" ou "2025-2026 F√©vrier"
  session   String                // "octobre" ou "fevrier"
  startDate DateTime               // Oct 2025 ou F√©v 2025
  endDate   DateTime               // Oct 2026 ou F√©v 2026
  
  isCurrent  Boolean @default(false)  // UNE SEULE ann√©e active √† la fois
  isArchived Boolean @default(false)  // Ann√©e termin√©e et archiv√©e
  
  // M√©tadonn√©es d'archivage
  archivedAt   DateTime?
  archivedById String?

  groups      Group[]
  courses     Course[]
  enrollments StudentEnrollment[]
  periodes    Periode[]
  payments    Payment[]
  generatedDocuments GeneratedDocument[]
  filieres   Filiere[]

  createdAt DateTime @default(now())
  deletedAt DateTime?
}

model Periode {
  id        String   @id @default(cuid())
  name      String           // "Semestre 1", "Trimestre 1", etc.
  code      String?          // "S1", "T1", "T2" pour identifier
  startDate DateTime
  endDate   DateTime
  
  isCurrent Boolean @default(false)  // P√©riode en cours

  academicYearId String
  academicYear   AcademicYear @relation(fields: [academicYearId], references: [id])

  notes     Note[]

  createdAt DateTime @default(now())
  deletedAt DateTime?
  
  @@unique([academicYearId, code])
}

// ---------------------------------------------------
//  UTILISATEURS
// ---------------------------------------------------

model User {
  id        String @id @default(cuid())
  email     String @unique
  password  String
  firstName String
  lastName  String
  role      String // "admin" | "administratif" | "prof" | "eleve"

  // üî• √âl√®ve rattach√© √† plusieurs sous-groupes (via UserSubGroups)
  subGroups SubGroup[] @relation("UserSubGroups")

  // üî• √âl√®ve/Prof rattach√© √† des fili√®res
  filieres Filiere[] @relation("UserFilieres")

  // üî• Professeurs / staff
  courses          Course[]        @relation("CourseProfessors")
  createdSessions  CourseSession[] @relation("CreatedSessions")
  teachingSessions CourseSession[] @relation("TeachingSessions")

  enrollments   StudentEnrollment[]
  presences     Presence[]
  notes         Note[]
  notifications Notification[]

  auditLogs            AuditLog[]           @relation("AuditUser")
  messageCampaignsCreated MessageCampaign[]
  campaignRecipients   CampaignRecipient[]
  importJobsCreated    ImportJob[]
  generatedDocuments   GeneratedDocument[]
  
  // Documents
  templatesCreated     DocumentTemplate[]   @relation("TemplateCreator")
  documentsGenerated   GeneratedDocument[]  @relation("DocumentGenerator")

  refreshTokens RefreshToken[]   // üëà AJOUT

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id])

  revoked   Boolean  @default(false)
  expiresAt DateTime

  createdAt DateTime @default(now())
}


// ---------------------------------------------------
//  GROUPES & SOUS-GROUPES
// ---------------------------------------------------

model Group {
  id    String  @id @default(cuid())
  name  String
  label String?

  academicYearId String
  academicYear   AcademicYear @relation(fields: [academicYearId], references: [id])

  subGroups      SubGroup[]
  targetSessions CourseSession[] @relation("TargetGroupSessions")

  createdAt DateTime @default(now())
  deletedAt DateTime?

  @@unique([academicYearId, name, deletedAt])
}

model SubGroup {
  id String @id @default(cuid())

  code    String          // "B3-DEV-A"
  label   String?

  groupId String
  group   Group  @relation(fields: [groupId], references: [id])

    subGroupFilieres SubGroupFiliere[] @relation("SubGroupToSubGroupFiliere")

  students User[]   @relation("UserSubGroups")
  courses  Course[] @relation("CourseSubGroups")

  targetSessions CourseSession[] @relation("TargetSubGroupSessions")

  mainEnrollments StudentEnrollment[] @relation("MainSubGroupEnrollment")

  createdAt DateTime @default(now())
  deletedAt DateTime?

  @@unique([groupId, code, deletedAt])
}

model Filiere {
  id             String   @id @default(cuid())
  code           String   // "INFO", "MARK", "RH"
  label          String?  // "Informatique", "Marketing"

  academicYearId String
  academicYear   AcademicYear @relation(fields: [academicYearId], references: [id])

  levelId String?
  level   Level?   @relation("FiliereLevel", fields: [levelId], references: [id], onDelete: SetNull)

  // Relations
  users     User[]      @relation("UserFilieres")
  courses   Course[]    @relation("FiliereCourses")
    subGroupFilieres SubGroupFiliere[] @relation("FiliereToSubGroupFiliere")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  @@unique([code, academicYearId])
  @@index([academicYearId])
  @@index([levelId])
}

model Level {
  id        String   @id @default(cuid())
  code      String   @unique  // "BAC+1", "BAC+2", "BAC+3", "BAC+4", "BAC+5"
  label     String?

  filieres Filiere[] @relation("FiliereLevel")

  createdAt DateTime @default(now())
  deletedAt DateTime?
}

// ---------------------------------------------------
//  COURS / MODULES
// ---------------------------------------------------

model Course {
  id   String @id @default(cuid())
  code String?      // optionnel : "JAV101"
  name String

  type   String? // cours, TD, TP
  domain String? // Informatique, Marketing‚Ä¶

  totalHours    Int?
  totalSessions Int?

  // coefficient pour bulletin
  coef Float? @default(1)

  academicYearId String
  academicYear   AcademicYear @relation(fields: [academicYearId], references: [id])

  // Fili√®re du cours
  filiereId String?
  filiere   Filiere? @relation("FiliereCourses", fields: [filiereId], references: [id])

  // Professeurs assign√©s
  professors User[] @relation("CourseProfessors")

  // Sous-groupes assign√©s
  subGroups SubGroup[] @relation("CourseSubGroups")

  sessions CourseSession[]
  notes    Note[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?
  
  @@index([filiereId])
}

// ---------------------------------------------------
//  SESSIONS (PLANNING)
// ---------------------------------------------------

enum AttendanceStatus {
  NOT_STARTED
  IN_PROGRESS
  DONE
}

model CourseSession {
  id String @id @default(cuid())

  startTime DateTime
  endTime   DateTime
  date      DateTime?    // redondant mais pratique

  attendanceStatus  AttendanceStatus @default(NOT_STARTED)
  attendanceTakenAt DateTime?        // quand le prof a r√©ellement fait l'appel

  targetGroupId    String?
  targetSubGroupId String?

  targetGroup    Group?    @relation("TargetGroupSessions", fields: [targetGroupId], references: [id])
  targetSubGroup SubGroup? @relation("TargetSubGroupSessions", fields: [targetSubGroupId], references: [id])

  courseId String
  course   Course @relation(fields: [courseId], references: [id])

  createdById String
  createdBy   User   @relation("CreatedSessions", fields: [createdById], references: [id])

  professorId String?
  professor   User?  @relation("TeachingSessions", fields: [professorId], references: [id])

  salleId String?
  salle   Room?   @relation(fields: [salleId], references: [id])

  presences     Presence[]
  notes         Note[]
  notifications Notification[] @relation("NotificationSession")

  createdAt DateTime @default(now())
  deletedAt DateTime?
}

// ---------------------------------------------------
//  SALLES
// ---------------------------------------------------

model Room {
  id       String @id @default(cuid())
  name     String
  capacity Int?

  sessions CourseSession[]

  createdAt DateTime @default(now())
  deletedAt DateTime?

  @@unique([name])
}

// ---------------------------------------------------
//  INSCRIPTIONS & PAIEMENTS
// ---------------------------------------------------

model StudentEnrollment {
  id             String @id @default(cuid())
  studentId      String
  student        User   @relation(fields: [studentId], references: [id])

  academicYearId String
  academicYear   AcademicYear @relation(fields: [academicYearId], references: [id])

  mainSubGroupId String?       // sous-groupe "principal"
  mainSubGroup   SubGroup? @relation("MainSubGroupEnrollment", fields: [mainSubGroupId], references: [id])

  // üî• AJOUT: R√¥le pour supporter profs et staff aussi
  role               String   @default("eleve") // "eleve", "prof", "admin", "administratif"

  status             String   @default("en_cours") // en_cours | termine | abandon | exclu
  isFinanciallyClear Boolean @default(false)

  totalFee   Float? // montant attendu
  comment    String?

  payments Payment[]

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  deletedAt  DateTime?
  
  @@unique([studentId, academicYearId, role])
  @@index([academicYearId, role])
}

model Payment {
  id            String @id @default(cuid())
  enrollmentId  String
  enrollment    StudentEnrollment @relation(fields: [enrollmentId], references: [id])

  academicYearId String
  academicYear   AcademicYear @relation(fields: [academicYearId], references: [id])

  amount   Float
  method   String?     // virement, CB‚Ä¶
  status   String      // pending, paid, cancelled
  dueDate  DateTime?
  paidAt   DateTime?

  reference String?

  createdAt DateTime @default(now())
  deletedAt DateTime?
}

// ---------------------------------------------------
//  PR√âSENCES
// ---------------------------------------------------

model Presence {
  id        String        @id @default(cuid())
  sessionId String
  session   CourseSession @relation(fields: [sessionId], references: [id])
  studentId String
  student   User          @relation(fields: [studentId], references: [id])

  status           String // "present" | "absent" | "retard" | "justifie"
  justified        Boolean @default(false)
  reason           String?
  validatedByAdmin Boolean @default(false)

  createdAt DateTime @default(now())
  deletedAt DateTime?

  @@unique([sessionId, studentId])
}

// ---------------------------------------------------
//  NOTES / BULLETINS
// ---------------------------------------------------

model Note {
  id        String @id @default(cuid())

  studentId String
  student   User   @relation(fields: [studentId], references: [id])

  courseId String
  course   Course @relation(fields: [courseId], references: [id])

  sessionId String?
  session   CourseSession? @relation(fields: [sessionId], references: [id])

  valeur      Float
  commentaire String?

  noteType String?   // DS, Projet, Examen‚Ä¶
  date     DateTime? // date r√©elle de l'√©valuation

  periodeId String?
  periode   Periode? @relation(fields: [periodeId], references: [id])

  isPublished Boolean @default(false) // visible pour l'√©l√®ve ou pas

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?
}

// ---------------------------------------------------
//  NOTIFICATIONS
// ---------------------------------------------------

model Notification {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id])

  title   String
  message String
  type    String      // "absence", "retard", "appel_non_fait", "note", etc.
  read    Boolean @default(false)

  relatedSessionId String?
  relatedSession   CourseSession? @relation("NotificationSession", fields: [relatedSessionId], references: [id])

  createdAt DateTime @default(now())
  deletedAt DateTime?
}

// ---------------------------------------------------
//  DOCUMENTS (mod√®les + instances)
// ---------------------------------------------------

model DocumentTemplate {
  id          String @id @default(cuid())
  name        String        // "Carte √©tudiant", "Certificat de scolarit√©"
  description String?       // description du template
  category    String?       // "certificat", "carte", "attestation", "courrier", etc.
  
  // Type de template
  templateType String @default("html")  // "html", "docx", "pdf"
  
  // Contenu du template
  content      String  @db.Text  // HTML avec placeholders {{firstName}}, {{lastName}}, etc.
  
  // Fichier source (pour .docx ou .pdf upload√©s)
  sourceFilePath String?        // chemin vers le fichier original upload√©
  sourceFileName String?        // nom du fichier original
  sourceMimeType String?        // "application/vnd.openxmlformats-officedocument.wordprocessingml.document", "application/pdf"
  
  // Variables disponibles dans le template
  availableFields Json?         // ["firstName", "lastName", "email", "subGroup.name", "academicYear.name", etc.]
  
  // Configuration d'affichage
  isActive    Boolean @default(true)
  isPublic    Boolean @default(false)  // visible par tous les admins/staff
  
  // Gestion des permissions
  createdById String?
  createdBy   User? @relation("TemplateCreator", fields: [createdById], references: [id])
  
  allowedRoles String[] @default(["admin", "administratif"])  // qui peut utiliser ce template
  
  // M√©tadonn√©es
  usageCount  Int @default(0)  // compteur d'utilisation
  lastUsedAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  generatedDocuments GeneratedDocument[]
}

model GeneratedDocument {
  id         String @id @default(cuid())
  templateId String
  template   DocumentTemplate @relation(fields: [templateId], references: [id])

  // Destinataire
  studentId String?
  student   User? @relation(fields: [studentId], references: [id])

  academicYearId String?
  academicYear   AcademicYear? @relation(fields: [academicYearId], references: [id])

  // Fichier g√©n√©r√©
  filePath     String?   // chemin vers le fichier g√©n√©r√©
  fileName     String?   // nom du fichier g√©n√©r√©
  fileSize     Int?      // taille en bytes
  mimeType     String?   // type du fichier g√©n√©r√©
  
  // Donn√©es utilis√©es pour la g√©n√©ration
  payload      Json?     // toutes les donn√©es inject√©es dans le template
  
  // Statut
  status       String @default("generated")  // "generated", "sent", "downloaded", "archived"
  downloadCount Int @default(0)
  
  // Qui a g√©n√©r√©
  generatedById String?
  generatedBy   User? @relation("DocumentGenerator", fields: [generatedById], references: [id])

  createdAt DateTime @default(now())
  deletedAt DateTime?
}

// ---------------------------------------------------
//  CHAMPS DYNAMIQUES (pour les templates)
// ---------------------------------------------------

model TemplateField {
  id          String @id @default(cuid())
  key         String @unique     // "student.firstName", "academicYear.name", "enrollment.totalFee"
  label       String            // "Pr√©nom de l'√©tudiant", "Ann√©e scolaire"
  description String?           // Description d√©taill√©e du champ
  category    String            // "student", "academicYear", "course", "enrollment", "custom"
  dataType    String            // "string", "number", "date", "boolean", "array"
  
  example     String?           // Exemple de valeur: "Jean", "2024-2025"
  isRequired  Boolean @default(false)
  
  // Pour les champs calcul√©s ou format√©s
  format      String?           // "uppercase", "lowercase", "date:DD/MM/YYYY", "currency:EUR"
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?
}

// ---------------------------------------------------
//  COMMUNICATIONS (campagnes)
// ---------------------------------------------------

model MessageCampaign {
  id      String @id @default(cuid())
  title   String
  content String         // contenu mail / message
  channel String         // "email", "sms", "internal"

  createdById String?
  createdBy   User? @relation(fields: [createdById], references: [id])

  createdAt DateTime @default(now())
  deletedAt DateTime?

  recipients CampaignRecipient[]
}

model CampaignRecipient {
  id         String @id @default(cuid())
  campaignId String
  campaign   MessageCampaign @relation(fields: [campaignId], references: [id])

  userId String?
  user   User? @relation(fields: [userId], references: [id])

  email  String?   // au cas o√π on envoie √† une adresse brute
  status String?   // sent, failed, opened, etc.
}

// ---------------------------------------------------
//  IMPORT / EXPORT (traces d'import Excel / JSON)
// ---------------------------------------------------

model ImportJob {
  id     String @id @default(cuid())
  type   String      // "users", "courses", "planning", "presences"‚Ä¶
  status String      // "pending", "running", "done", "error"

  createdById String?
  createdBy   User? @relation(fields: [createdById], references: [id])

  totalRows    Int?
  successCount Int?
  errorCount   Int?

  sourceFile String?   // chemin ou nom de fichier
  rawPreview Json?     // √©ventuellement aper√ßu des 10 premi√®res lignes

  rowErrors ImportRowError[]

  createdAt  DateTime @default(now())
  finishedAt DateTime?
}

model ImportRowError {
  id          String @id @default(cuid())
  importJobId String
  importJob   ImportJob @relation(fields: [importJobId], references: [id])

  rowNumber Int
  error     String
  rawData   Json?
}

// ---------------------------------------------------
//  AUDIT LOG
// ---------------------------------------------------

model AuditLog {
  id     String @id @default(cuid())
  userId String?
  user   User? @relation("AuditUser", fields: [userId], references: [id])

  action   String      // "CREATE_USER", "UPDATE_NOTE", "DELETE_SESSION"‚Ä¶
  entity   String      // "User", "Course", "Presence", etc.
  entityId String?
  details  Json?

  createdAt DateTime @default(now())
}

// ---------------------------------------------------
//  PERMISSIONS (comme avant)
// ---------------------------------------------------

model Permission {
  id          String           @id @default(cuid())
  key         String           @unique
  label       String
  description String?
  roleLinks   RolePermission[]
}

model RolePermission {
  id           String     @id @default(cuid())
  role         String
  permissionId String
  permission   Permission @relation(fields: [permissionId], references: [id])
  value        Boolean    @default(false)

  @@unique([role, permissionId])
}

// ---------------------------------------------------
//  ERD GENERATOR
// ---------------------------------------------------

generator erd {
  provider = "prisma-erd-generator"
  output   = "./diagram/erd.svg"
}
